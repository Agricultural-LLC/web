---
import CollectionLayout from "@components/agritech/CollectionLayout.astro";
import { 
  getFirebaseBlogEntries, 
  getFirebaseCategories, 
  getFirebaseTags,
  type BlogEntry 
} from "@lib/firebaseLoader";

const { slug } = Astro.params;
const currentPageIndex = slug && !isNaN(Number(slug)) ? Number(slug) : 1;

// Firebaseから記事を取得
const entries = await getFirebaseBlogEntries();
const categories = await getFirebaseCategories();
const tags = await getFirebaseTags();

// 仮のentryIndex（ブログトップページ情報）
const entryIndex: BlogEntry = {
  id: 'blog-index',
  slug: 'blog',
  title: '農てっく!',
  description: 'スマート農業やデジタル技術を活用した農業の最新情報をお届けします',
  date: new Date(),
  image: '',
  authors: ['農業合同会社'],
  categories: [],
  tags: [],
  draft: false,
  url: '/agritech/'
};

// カテゴリの頻度計算（allCategories相当）
const allCategories: string[] = [];
entries.forEach(entry => {
  entry.categories.forEach(category => {
    allCategories.push(category);
  });
});

const entriesPerPage = 4;
const indexOfLastEntry = currentPageIndex * entriesPerPage;
const indexOfFirstEntry = indexOfLastEntry - entriesPerPage;
const currentEntries = entries.slice(indexOfFirstEntry, indexOfLastEntry);

const pageCount: number = Math.ceil(entries.length / entriesPerPage);
---

<CollectionLayout
  entryIndex={entryIndex}
  entries={currentEntries}
  categories={categories}
  tags={tags}
  allCategories={allCategories}
  pageIndex={currentPageIndex}
  pageCount={pageCount}
/>
